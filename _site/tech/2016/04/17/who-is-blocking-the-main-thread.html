
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="'A coder wanna to make a difference.">
  <meta name="author" content="Kyle Wong">
  <meta name="keywords" content="Kyle, Blog, iOS, Tech, Science">
  <link rel="canonical" href="/tech/2016/04/17/who-is-blocking-the-main-thread.html">
  <title>{ Kyle Wong } | iOS UI 卡顿监测</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  
    <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
  

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  
<!-- Chrome, Firefox OS and Opera -->
<meta name="theme-color" content="#000000">
<!-- Windows Phone -->
<meta name="msapplication-navbutton-color" content="#000000">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">


  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->


  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            
              <img src="/img/black-lab-glass.ico" alt="">
            
            { Kyle Wong }
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section text-center">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>iOS UI 卡顿监测</strong></h1>
          <h4>
            <strong>17 Apr 2016</strong>
            <small>
              . category:
              <a class="category" href="/categories/tech.html">
                tech
              </a>.
              <a href="/tech/2016/04/17/who-is-blocking-the-main-thread.html#disqus_thread">Comments</a>
              <br />
              
                <a class="tag" href="/tags/tutorial.html">#tutorial</a>
              
            </small>
          </h4>

          <h3 id="contents">Contents</h3>

<ol>
  <li>Runloop</li>
  <li>Thread frames retrieve.</li>
  <li>Mainthread timeout detection</li>
  <li>Address symbolicating</li>
</ol>

<h3 id="runloop">Runloop</h3>
<p><img src="https://raw.githubusercontent.com/kangwang1988/kangwang1988.github.io/master/img/runloop.jpg" alt="Runloop" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Runloop modes:
	NSDefaultRunLoopMode、UITrackingRunLoopMode、NSRunLoopCommonModes
</code></pre>
</div>

<h3 id="thread--frames-retrieve-at-runtime">Thread  frames retrieve at runtime</h3>

<p>Darwin kernel:</p>

<p><img src="https://raw.githubusercontent.com/kangwang1988/kangwang1988.github.io/master/img/darwin.png" alt="Darwin" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Mach:Micro kernel, very limited basic services like CPU scheduling, IPC etc.
BSD: A ring surrounding Mach layer, providing process management, file system,network,etc.
IOKit: A object oriented framework provided by device driver.
</code></pre>
</div>

<p>Get threads of current process:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>task_threads:Return the target task's list of threads.
kern_return_t task_threads(task_t task,thread_act_port_array_t thread_list,					  mach_msg_type_number_t *thread_count);
</code></pre>
</div>

<p>Get thread state of certain thread:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>thread_get_state:Return the execution state (for example, the machine registers) for target thread.
kern_return_t thread_get_state(thread_act_t target_thread,
								thread_state_flavor_t flavor,
             					thread_state_t old_state,
             					mach_msg_type_number_t old_state_count);
             					
ARM_THREAD_STATE/ARM_VFP_STATE/ARM_EXCEPTION_STATE
</code></pre>
</div>

<p>Read pc from registers.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>_STRUCT_ARM_THREAD_STATE
{
	__uint32_t	__r[13];	/* General purpose register r0-r12 */
	__uint32_t	__sp;		/* Stack pointer r13 */
	__uint32_t	__lr;		/* Link register r14 */
	__uint32_t	__pc;		/* Program counter r15 */
	__uint32_t	__cpsr;		/* Current program status register */
};
</code></pre>
</div>

<p>Traverse all frames:
<img src="https://raw.githubusercontent.com/kangwang1988/kangwang1988.github.io/master/img/arm_stack.jpg" alt="Darwin" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>R7:frame pointer
1.Get old R7 and LR from R7.
2.Read old R7 as new R7.
3.Goto 1 until old R7 is NULL.
</code></pre>
</div>

<h3 id="mainthread-timeout-detection">Mainthread timeout detection</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>1.Register a observer for runloop wakeup/sleep with CFRunLoopAddObserver.

CF_EXPORT void CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef 										 observer, CFStringRef mode);

2.When the observer is called, record the current timestamp(ts) by distinguishing the CFRunLoopActivity.

kCFRunLoopBeforeWaiting:Inside the event processing loop before the run loop sleeps, waiting for a source or timer to fire.
kCFRunLoopAfterWaiting:Inside the event processing loop after the run loop wakes up, but before processing the event that woke it up. This activity occurs only if the run loop did in fact go to sleep during the current loop.

3.Do time checking timely in another thread(which started with step 1).When the timeinterval between now and the recorded start time is over certain threshold, record the callback trees in each thread.
</code></pre>
</div>

<h3 id="address-symbolicating">Address symbolicating</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>When a mainthread timeout is detected, you will get a callback tree in each threads.
An example is given as below: ![Darwin](https://raw.githubusercontent.com/kangwang1988/kangwang1988.github.io/master/img/stuckbacktree.png)

The frame is followed by an offset address(stackaddress-loadaddress).When you want to symbolicate it, you should get the slide first.
otool -arch armv7 -l KWToolKit.app/KWToolKit | grep -B 3 -A 8 -m 2 "__TEXT" ![Darwin](https://raw.githubusercontent.com/kangwang1988/kangwang1988.github.io/master/img/slide.png)

The symbol address would be:
	symbol address = slide+offset 

Symbolicate the symbol using:
dwarfdump --arch ARCHITECTURE PATH-TO-YOUR-BINARY --lookup symbol-address
</code></pre>
</div>

<p><a href="https://github.com/kangwang1988/KWToolKit">Check out the demo probject at github.</a></p>


          
<!-- Share Buttons Start -->
<div>
  <ul class="rrssb-buttons clearfix">
    
      <li class="rrssb-email">
        <a href="mailto:?subject=iOS UI 卡顿监测&body=https://kangwang1988.github.io/tech/2016/04/17/who-is-blocking-the-main-thread.html" data-proofer-ignore>
          <span class="rrssb-icon">
            <svg xmlns="https://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
              <path d="M20.11 26.147c-2.335 1.05-4.36 1.4-7.124 1.4C6.524 27.548.84 22.916.84 15.284.84 7.343 6.602.45 15.4.45c6.854 0 11.8 4.7 11.8 11.252 0 5.684-3.193 9.265-7.398 9.3-1.83 0-3.153-.934-3.347-2.997h-.077c-1.208 1.986-2.96 2.997-5.023 2.997-2.532 0-4.36-1.868-4.36-5.062 0-4.75 3.503-9.07 9.11-9.07 1.713 0 3.7.4 4.6.972l-1.17 7.203c-.387 2.298-.115 3.3 1 3.4 1.674 0 3.774-2.102 3.774-6.58 0-5.06-3.27-8.994-9.304-8.994C9.05 2.87 3.83 7.545 3.83 14.97c0 6.5 4.2 10.2 10 10.202 1.987 0 4.09-.43 5.647-1.245l.634 2.22zM16.647 10.1c-.31-.078-.7-.155-1.207-.155-2.572 0-4.596 2.53-4.596 5.53 0 1.5.7 2.4 1.9 2.4 1.44 0 2.96-1.83 3.31-4.088l.592-3.72z"
              />
            </svg>
          </span>
          <span class="rrssb-text">email</span>
        </a>
      </li>
    
    
    
      <li class="rrssb-twitter">
        <a href="https://twitter.com/share?url=https://kangwang1988.github.io/tech/2016/04/17/who-is-blocking-the-main-thread.html&text=iOS UI 卡顿监测"
        class="popup">
          <span class="rrssb-icon"><svg xmlns="https://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28"><path d="M24.253 8.756C24.69 17.08 18.297 24.182 9.97 24.62c-3.122.162-6.22-.646-8.86-2.32 2.702.18 5.375-.648 7.507-2.32-2.072-.248-3.818-1.662-4.49-3.64.802.13 1.62.077 2.4-.154-2.482-.466-4.312-2.586-4.412-5.11.688.276 1.426.408 2.168.387-2.135-1.65-2.73-4.62-1.394-6.965C5.574 7.816 9.54 9.84 13.802 10.07c-.842-2.738.694-5.64 3.434-6.48 2.018-.624 4.212.043 5.546 1.682 1.186-.213 2.318-.662 3.33-1.317-.386 1.256-1.248 2.312-2.4 2.942 1.048-.106 2.07-.394 3.02-.85-.458 1.182-1.343 2.15-2.48 2.71z"/></svg></span>
          <span class="rrssb-text">twitter</span>
        </a>
      </li>
    
    
      <li class="rrssb-linkedin">
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://kangwang1988.github.io/tech/2016/04/17/who-is-blocking-the-main-thread.html" class="popup">
        <span class="rrssb-icon">
          <svg xmlns="https://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
            <path d="M25.424 15.887v8.447h-4.896v-7.882c0-1.98-.71-3.33-2.48-3.33-1.354 0-2.158.91-2.514 1.802-.13.315-.162.753-.162 1.194v8.216h-4.9s.067-13.35 0-14.73h4.9v2.087c-.01.017-.023.033-.033.05h.032v-.05c.65-1.002 1.812-2.435 4.414-2.435 3.222 0 5.638 2.106 5.638 6.632zM5.348 2.5c-1.676 0-2.772 1.093-2.772 2.54 0 1.42 1.066 2.538 2.717 2.546h.032c1.71 0 2.77-1.132 2.77-2.546C8.056 3.593 7.02 2.5 5.344 2.5h.005zm-2.48 21.834h4.896V9.604H2.867v14.73z"
            />
          </svg>
        </span>
        <span class="rrssb-text">linkedin</span>
      </a>
      </li>
    
    
    
    
    
    
    
  </ul>
</div>

<!-- Share Buttons End -->


          


          <hr />

          
          <div class="author row">
            <img class="col-xs-4 col-sm-3 col-md-2" src="/img/author.png" alt="Me" />
            <p class="col-xs-8 col-sm-9 col-md-10">
              Kyle is a iOS developer in China. He likes mathematics,physics,art,computer science. In his spare time, he would like to read books, write some codes he likes, go swimming or hiking.
            </p>
          </div>
          
        </div>
      </div>
    </section>

    
 <!-- Footer Start -->

<footer>

    
<!-- Social Buttons Start -->

<ul class="list-inline social-buttons">
  
    <li><a href="https://weibo.com/" target="_blank"><i class="fa fa-weibo fa-fw"></i></a></li>
  
    <li><a href="https://github.com/kangwang1988" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="/feed.xml" target="_blank"><i class="fa fa-rss fa-fw"></i></a></li>
  
    <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
    <li><a href="https://twitter.com/" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


    <p><br><br></p>

    <div class="container text-center">
      <p>Copyright &copy; Kyle Wong 2016</p>
    </div>
</footer>

<p><br><br><br><br><br><br></p>

<!-- Footer End -->


    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>





  <!-- Syntax highlight in post pages-->

  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>









  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'iOS UI 卡顿监测', 'https://kangwang1988.github.io/tech/2016/04/17/who-is-blocking-the-main-thread.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/tech/2016/04/10/mactalk-reading-notes.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("/tech/2016/04/20/hackers-and-painters-reading-notes.html");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->


  </body>
</html>

<!-- Post Layout End -->
